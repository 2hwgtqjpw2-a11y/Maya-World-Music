<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Maya World Music</title>

    <!-- Privacy & Security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.googleapis.com https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://i.ytimg.com https://piped.video https://pipedproxy.kavin.rocks https://pipedapi.kavin.rocks https://pipedapi-libre.kavin.rocks https://piped-api.garudalinux.org https://pipedapi.tokhmi.xyz https://pipedapi.moomoo.me https://invidious.jing.rocks https://iv.ggtyler.dev https://invidious.privacydev.net https://inv.tux.pizza https://vid.puffyan.us; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://piped.video https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com https://cdnjs.cloudflare.com; frame-src https://piped.video https://pipedproxy.kavin.rocks; connect-src 'self' https://www.googleapis.com https://piped.video https://pipedapi.kavin.rocks https://pipedapi-libre.kavin.rocks https://piped-api.garudalinux.org https://pipedapi.tokhmi.xyz https://pipedapi.moomoo.me https://invidious.jing.rocks https://iv.ggtyler.dev https://invidious.privacydev.net https://inv.tux.pizza https://vid.puffyan.us;">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">

    <!-- PWA Meta Tags -->
    <meta name="description" content="Your personal music player powered by YouTube">
    <meta name="theme-color" content="#0a0e1a">
    <link rel="manifest" href="manifest.json">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Maya World Music">
    <link rel="apple-touch-icon" href="icon-180.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #12172b;
            --bg-tertiary: #1a2138;
            --accent-primary: #00d9ff;
            --accent-secondary: #ff00d4;
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --text-muted: #6b7a99;
            --border-color: #2a3a5a;
            --hover-bg: #1e2a45;
            --shadow: 0 8px 32px rgba(0, 217, 255, 0.1);
        }

        .light {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9ecef;
            --accent-primary: #0099cc;
            --accent-secondary: #cc0099;
            --text-primary: #1a1a1a;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --hover-bg: #e9ecef;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }

        .nav-item i {
            width: 24px;
            font-size: 20px;
        }

        .playlists-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .playlists-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .playlist-item {
            padding: 10px 16px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .playlist-item:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            background: var(--bg-primary);
            overflow-y: auto;
            padding: 32px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .content-title {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            background-clip: text;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 16px;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
        }

        /* Track Grid */
        .tracks-grid {
            display: grid;
            gap: 16px;
        }

        .track-item {
            display: grid;
            grid-template-columns: 48px 1fr auto auto;
            gap: 16px;
            padding: 12px;
            border-radius: 8px;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .track-item:hover {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .track-item.playing {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }

        .track-number {
            font-family: 'Space Mono', monospace;
            color: var(--text-muted);
            text-align: center;
            font-size: 14px;
        }

        .track-item.playing .track-number {
            color: var(--accent-primary);
        }

        .track-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .track-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            color: var(--text-muted);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-duration {
            font-family: 'Space Mono', monospace;
            color: var(--text-muted);
            font-size: 14px;
        }

        .track-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .track-item:hover .track-actions {
            opacity: 1;
        }

        .track-action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            font-size: 16px;
        }

        .track-action-btn:hover {
            color: var(--accent-primary);
            background: var(--hover-bg);
        }

        /* Player */
        .player {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 16px 24px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 24px;
            align-items: center;
        }

        .player-track-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .player-album-art {
            width: 56px;
            height: 56px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .player-track-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .player-track-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-track-artist {
            color: var(--text-muted);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .player-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .player-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
            border-radius: 50%;
            font-size: 18px;
        }

        .player-btn:hover {
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .player-btn.play-btn {
            background: var(--accent-primary);
            color: var(--bg-primary);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .player-btn.play-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }

        .player-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .player-time {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            min-width: 40px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .player-extra {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 16px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .volume-slider {
            width: 100px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .volume-slider-fill {
            height: 100%;
            background: var(--text-secondary);
            border-radius: 3px;
            width: 70%;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 280px;
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .content-area {
                padding: 16px;
                padding-bottom: 20px;
            }

            .content-title {
                font-size: 32px;
            }

            .player {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 16px;
                transition: transform 0.3s ease;
            }

            .player.hidden-mobile {
                transform: translateY(100%);
                pointer-events: none;
            }

            .player-btn {
                padding: 12px;
                font-size: 22px;
            }

            .player-btn.play-btn {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .player-buttons {
                gap: 24px;
            }

            .player-extra {
                justify-content: center;
                gap: 20px;
            }

            .volume-control {
                display: none; /* Hide volume slider on mobile to save space */
            }

            .track-item {
                grid-template-columns: 32px 1fr auto auto;
                gap: 8px;
                padding: 12px 8px;
            }

            .track-number {
                font-size: 12px;
            }

            .track-actions {
                display: flex !important;
                opacity: 1 !important;
                gap: 4px;
            }

            .track-action-btn {
                padding: 6px;
                font-size: 14px;
            }

            .track-duration {
                font-size: 12px;
            }

            /* Mobile search improvements - Full screen overlay */
            body.search-view .search-container.active {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height - excludes keyboard */
                z-index: 2000;
                background: var(--bg-primary);
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            body.search-view .content-header {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 2001;
                background: var(--bg-primary);
                padding: 16px;
                padding-top: 60px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                gap: 12px;
                flex-shrink: 0;
            }

            body.search-view .content-title {
                font-size: 24px;
                flex: 1;
            }

            body.search-view .theme-toggle {
                display: none;
            }

            body.search-view .search-wrapper {
                position: absolute;
                top: 110px;
                left: 16px;
                right: 16px;
                z-index: 2001;
                flex-shrink: 0;
            }

            body.search-view #searchResults {
                position: absolute;
                top: 180px;
                left: 0;
                right: 0;
                bottom: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 16px 20px 16px;
            }

            .search-result-item {
                grid-template-columns: 48px 1fr;
                gap: 12px;
            }

            .add-song-btn {
                grid-column: 1 / -1;
                margin-top: 8px;
            }

            /* Hide player on search view */
            body.search-view .player {
                display: none;
            }

            body.search-view .tracks-grid {
                display: none;
            }

            /* Back button for search */
            .search-back-btn {
                display: none;
                position: fixed;
                top: 16px;
                left: 16px;
                z-index: 2002;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                width: 40px;
                height: 40px;
                border-radius: 50%;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                cursor: pointer;
                box-shadow: var(--shadow);
            }

            body.search-view .search-back-btn {
                display: flex;
            }

            body.search-view .mobile-menu-btn {
                display: none;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .track-item {
            animation: fadeIn 0.3s ease-out backwards;
        }

        .track-item:nth-child(1) { animation-delay: 0.05s; }
        .track-item:nth-child(2) { animation-delay: 0.1s; }
        .track-item:nth-child(3) { animation-delay: 0.15s; }
        .track-item:nth-child(4) { animation-delay: 0.2s; }
        .track-item:nth-child(5) { animation-delay: 0.25s; }
        .track-item:nth-child(6) { animation-delay: 0.3s; }
        .track-item:nth-child(7) { animation-delay: 0.35s; }
        .track-item:nth-child(8) { animation-delay: 0.4s; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease-out;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 24px;
            padding: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        /* Search Bar */
        .search-container {
            margin-bottom: 24px;
            display: none;
        }

        .search-container.active {
            display: block;
        }

        .search-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            padding-left: 48px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 16px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow);
        }

        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 18px;
            pointer-events: none;
        }

        #searchResults {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .playlist-item.active {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }

        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        /* Search Results */
        .search-results {
            display: grid;
            gap: 12px;
            margin-top: 24px;
        }

        .search-result-item {
            display: grid;
            grid-template-columns: 56px 1fr auto;
            gap: 16px;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            align-items: center;
            transition: all 0.2s;
            animation: fadeIn 0.3s ease-out backwards;
        }

        .search-result-item:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .search-result-art {
            width: 56px;
            height: 56px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .search-result-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0;
        }

        .search-result-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        .search-result-artist {
            color: var(--text-muted);
            font-size: 14px;
        }

        .search-result-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .add-song-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .add-song-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .add-song-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-loading {
            text-align: center;
            padding: 48px;
            color: var(--text-muted);
        }

        .search-loading i {
            font-size: 48px;
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .search-hint {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .search-hint i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .search-hint h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        /* YouTube Player */
        #youtube-player {
            position: fixed;
            bottom: -500px;
            left: 0;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        .youtube-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #ff0000;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .search-result-item.has-youtube {
            border-color: rgba(255, 0, 0, 0.3);
        }

        .playlist-item-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .playlist-item-wrapper:hover {
            background: var(--hover-bg);
        }

        .playlist-item-wrapper.active {
            background: var(--bg-tertiary);
        }

        .playlist-item-name {
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .playlist-item-wrapper.active .playlist-item-name {
            color: var(--accent-primary);
        }

        .playlist-item-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0;
            transition: all 0.2s;
            font-size: 14px;
        }

        .playlist-item-wrapper:hover .playlist-item-delete {
            opacity: 1;
        }

        .playlist-item-delete:hover {
            color: var(--accent-secondary);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .content-header {
                margin-bottom: 16px;
                padding-top: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Search Back Button -->
        <button class="search-back-btn" id="searchBackBtn">
            <i class="fas fa-arrow-left"></i>
        </button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="logo">MAYA WORLD MUSIC <small style="font-size: 10px; opacity: 0.5;">v2.0</small></div>

                <div class="nav-section">
                    <div class="nav-item active" data-view="home">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </div>
                    <div class="nav-item" data-view="search">
                        <i class="fas fa-search"></i>
                        <span>Search</span>
                    </div>
                    <div class="nav-item" data-view="library">
                        <i class="fas fa-book"></i>
                        <span>Your Library</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-item" id="createPlaylistBtn">
                        <i class="fas fa-plus-circle"></i>
                        <span>Create Playlist</span>
                    </div>
                    <div class="nav-item" id="manualAddBtn">
                        <i class="fas fa-plus"></i>
                        <span>Add Song Manually</span>
                    </div>
                    <div class="nav-item" data-view="liked">
                        <i class="fas fa-heart"></i>
                        <span>Liked Songs</span>
                    </div>
                    <div class="nav-item" id="settingsBtn">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                </div>

                <div class="playlists-section">
                    <div class="playlists-header">
                        <span>Playlists</span>
                    </div>
                    <div id="playlistsContainer">
                        <!-- Playlists will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="content-header">
                    <h1 class="content-title" id="contentTitle">Discover</h1>
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>

                <div class="search-container" id="searchContainer">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search for songs, artists, or albums...">
                    </div>
                    <div id="searchResults">
                        <!-- Search results will be populated by JavaScript -->
                    </div>
                </div>

                <div class="tracks-grid" id="tracksGrid">
                    <!-- Tracks will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Player -->
        <div class="player">
            <div class="player-track-info">
                <div class="player-album-art">
                    <i class="fas fa-music"></i>
                </div>
                <div class="player-track-details">
                    <div class="player-track-name">No track playing</div>
                    <div class="player-track-artist">Select a track to play</div>
                </div>
            </div>

            <div class="player-controls">
                <div class="player-buttons">
                    <button class="player-btn" id="shuffleBtn">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="player-btn" id="prevBtn">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="player-btn play-btn" id="playBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="player-btn" id="nextBtn">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="player-btn" id="repeatBtn">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="player-progress">
                    <span class="player-time" id="currentTime">0:00</span>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-bar-fill" id="progressBarFill"></div>
                    </div>
                    <span class="player-time" id="totalTime">0:00</span>
                </div>
            </div>

            <div class="player-extra">
                <div class="volume-control">
                    <button class="player-btn" id="volumeBtn">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <div class="volume-slider" id="volumeSlider">
                        <div class="volume-slider-fill" id="volumeSliderFill"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Video Player (Piped - Ad-Free!) -->
        <iframe id="video-player" style="display: none;" width="1" height="1" frameborder="0" allowfullscreen allow="autoplay"></iframe>
    </div>

    <script>
        // Sample tracks data
        let tracks = [
            { id: 1, name: 'Midnight Echo', artist: 'Neon Dreams', duration: 243, frequency: 440, liked: false, youtubeId: null },
            { id: 2, name: 'Digital Sunrise', artist: 'Synth Wave', duration: 198, frequency: 523.25, liked: false, youtubeId: null },
            { id: 3, name: 'Cosmic Journey', artist: 'Space Riders', duration: 267, frequency: 329.63, liked: false, youtubeId: null },
            { id: 4, name: 'Electric Heart', artist: 'Pulse', duration: 215, frequency: 392, liked: false, youtubeId: null },
            { id: 5, name: 'Neon Nights', artist: 'Retrowave', duration: 189, frequency: 493.88, liked: false, youtubeId: null },
            { id: 6, name: 'Future Memories', artist: 'Chrome Dreams', duration: 234, frequency: 261.63, liked: false, youtubeId: null },
            { id: 7, name: 'Velocity', artist: 'Fast Lane', duration: 201, frequency: 587.33, liked: false, youtubeId: null },
            { id: 8, name: 'Aurora', artist: 'Northern Lights', duration: 256, frequency: 349.23, liked: false, youtubeId: null }
        ];

        // Playlists
        let playlists = [
            { id: 1, name: 'Chill Vibes', tracks: [1, 3, 6] },
            { id: 2, name: 'Workout Mix', tracks: [4, 5, 7] },
            { id: 3, name: 'Focus Flow', tracks: [2, 6, 8] }
        ];

        // Settings (stored in cookies since localStorage doesn't work in iframe)
        let youtubeApiKey = getCookie('ytApiKey') || '';

        // State
        let currentTrack = null;
        let isPlaying = false;
        let currentTime = 0;
        let volume = 0.7;
        let isShuffle = false;
        let repeatMode = 0; // 0: off, 1: repeat all, 2: repeat one
        let currentView = 'home';
        let currentPlaylist = null;
        let searchQuery = '';
        let nextTrackId = 9;
        let nextPlaylistId = 4;

        // Web Audio API
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;
        let animationFrame = null;

        // Video Player (Piped - Ad-Free!)
        let videoPlayer = null;
        let videoPlayerReady = false;
        const pipedInstance = 'https://piped.video'; // Ad-free YouTube frontend

        // DOM Elements
        const tracksGrid = document.getElementById('tracksGrid');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const volumeBtn = document.getElementById('volumeBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeSliderFill = document.getElementById('volumeSliderFill');
        const themeToggle = document.getElementById('themeToggle');
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        const contentTitle = document.getElementById('contentTitle');
        const playlistsContainer = document.getElementById('playlistsContainer');
        const createPlaylistBtn = document.getElementById('createPlaylistBtn');
        const manualAddBtn = document.getElementById('manualAddBtn');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const searchResults = document.getElementById('searchResults');
        const searchBackBtn = document.getElementById('searchBackBtn');

        // Search state
        let searchTimeout = null;
        let isSearching = false;
        let currentSearchResults = [];

        // Initialize Video Player (Piped - No Ads!)
        function initVideoPlayer() {
            videoPlayer = document.getElementById('video-player');
            videoPlayerReady = true;
            console.log('âœ… Ad-free video player ready (Piped)');
        }

        // Wake Lock to prevent screen sleep during playback
        let wakeLock = null;

        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) {
                console.log('Wake Lock API not supported');
                return;
            }

            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('ðŸ”“ Wake Lock activated - screen will stay on');

                wakeLock.addEventListener('release', () => {
                    console.log('ðŸ”’ Wake Lock released');
                });
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // Media Session API for background playback and lock screen controls
        function updateMediaSession() {
            if (!currentTrack || !('mediaSession' in navigator)) return;

            navigator.mediaSession.metadata = new MediaMetadata({
                title: currentTrack.name,
                artist: currentTrack.artist,
                album: 'Maya World Music',
                artwork: currentTrack.youtubeId ? [
                    { src: `https://i.ytimg.com/vi/${currentTrack.youtubeId}/default.jpg`, sizes: '120x90', type: 'image/jpeg' },
                    { src: `https://i.ytimg.com/vi/${currentTrack.youtubeId}/mqdefault.jpg`, sizes: '320x180', type: 'image/jpeg' },
                    { src: `https://i.ytimg.com/vi/${currentTrack.youtubeId}/hqdefault.jpg`, sizes: '480x360', type: 'image/jpeg' }
                ] : []
            });

            // Set up action handlers for lock screen controls
            navigator.mediaSession.setActionHandler('play', () => {
                startPlayback();
            });

            navigator.mediaSession.setActionHandler('pause', () => {
                pausePlayback();
            });

            navigator.mediaSession.setActionHandler('previoustrack', () => {
                playPreviousTrack();
            });

            navigator.mediaSession.setActionHandler('nexttrack', () => {
                playNextTrack();
            });

            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                if (youtubePlayer && currentTrack.youtubeId) {
                    const seekTime = Math.max(0, youtubePlayer.getCurrentTime() - (details.seekOffset || 10));
                    youtubePlayer.seekTo(seekTime, true);
                }
            });

            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                if (youtubePlayer && currentTrack.youtubeId) {
                    const seekTime = youtubePlayer.getCurrentTime() + (details.seekOffset || 10);
                    youtubePlayer.seekTo(seekTime, true);
                }
            });

            console.log('ðŸ“± Media Session updated for background playback');
        }

        // Initialize
        function init() {
            renderTracks();
            renderPlaylists();
            setupEventListeners();
            updateVolumeUI();

            // Initialize ad-free video player
            initVideoPlayer();

            // Dark mode detection
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        // Get tracks to display
        function getTracksToDisplay() {
            let filteredTracks = tracks;

            // Filter by view
            if (currentView === 'liked') {
                filteredTracks = tracks.filter(t => t.liked);
            } else if (currentView === 'playlist' && currentPlaylist) {
                const playlist = playlists.find(p => p.id === currentPlaylist);
                if (playlist) {
                    filteredTracks = tracks.filter(t => playlist.tracks.includes(t.id));
                }
            } else if (currentView === 'library') {
                filteredTracks = tracks;
            }

            // Filter by search
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredTracks = filteredTracks.filter(t =>
                    t.name.toLowerCase().includes(query) ||
                    t.artist.toLowerCase().includes(query)
                );
            }

            return filteredTracks;
        }

        // Render tracks
        function renderTracks() {
            const displayTracks = getTracksToDisplay();

            if (displayTracks.length === 0) {
                tracksGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-music"></i>
                        <h3>No songs found</h3>
                        <p>${searchQuery ? 'Try a different search term' : 'Add some songs to get started'}</p>
                    </div>
                `;
                return;
            }

            tracksGrid.innerHTML = displayTracks.map((track, index) => `
                <div class="track-item" data-track-id="${track.id}">
                    <div class="track-number">${String(index + 1).padStart(2, '0')}</div>
                    <div class="track-info">
                        <div class="track-name">${track.name}</div>
                        <div class="track-artist">${track.artist}</div>
                    </div>
                    <div class="track-duration">${formatTime(track.duration)}</div>
                    <div class="track-actions">
                        <button class="track-action-btn" onclick="openAddToPlaylistModal(${track.id})" title="Add to playlist">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="track-action-btn" onclick="toggleLikeTrack(${track.id})" title="Like song">
                            <i class="${track.liked ? 'fas' : 'far'} fa-heart" style="${track.liked ? 'color: var(--accent-secondary)' : ''}"></i>
                        </button>
                        <button class="track-action-btn" onclick="deleteTrack(${track.id})" title="Delete song">
                            <i class="fas fa-trash" style="color: var(--accent-secondary);"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Add click listeners to tracks
            document.querySelectorAll('.track-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.track-action-btn')) {
                        const trackId = parseInt(item.dataset.trackId);
                        playTrack(trackId);
                    }
                });
            });
        }

        // Render playlists
        function renderPlaylists() {
            if (playlists.length === 0) {
                playlistsContainer.innerHTML = '<div style="padding: 10px 16px; color: var(--text-muted); font-size: 12px;">No playlists yet</div>';
                return;
            }

            playlistsContainer.innerHTML = playlists.map(playlist => `
                <div class="playlist-item-wrapper ${currentPlaylist === playlist.id ? 'active' : ''}" data-playlist-id="${playlist.id}">
                    <div class="playlist-item-name" onclick="viewPlaylist(${playlist.id})">${playlist.name}</div>
                    <button class="playlist-item-delete" onclick="deletePlaylist(${playlist.id})" title="Delete playlist">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);

            progressBar.addEventListener('click', seekTrack);
            volumeSlider.addEventListener('click', changeVolume);
            volumeBtn.addEventListener('click', toggleMute);

            themeToggle.addEventListener('click', toggleTheme);

            // Navigation
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    const view = item.dataset.view;
                    switchView(view);
                });
            });

            createPlaylistBtn.addEventListener('click', openCreatePlaylistModal);
            manualAddBtn.addEventListener('click', openManualAddModal);
            document.getElementById('settingsBtn').addEventListener('click', openSettings);

            // Search - different behavior based on view
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;

                if (currentView === 'search') {
                    // In search view, search for new songs to add
                    handleSearch(query);
                } else {
                    // In other views, filter existing library
                    searchQuery = query;
                    renderTracks();
                }
            });

            // Mobile menu
            mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            sidebarOverlay.addEventListener('click', closeMobileMenu);

            // Search back button
            searchBackBtn.addEventListener('click', () => {
                switchView('home');
            });

            // Register Poe handler for search results
            if (window.Poe) {
                window.Poe.registerHandler('search-handler', handleSearchResponse);
            }
        }

        // Handle search input
        function handleSearch(query) {
            clearTimeout(searchTimeout);

            if (!query.trim()) {
                displaySearchHint();
                return;
            }

            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 500); // Debounce 500ms
        }

        // Perform search with Poe API or YouTube directly
        async function performSearch(query) {
            if (window.Poe) {
                // Use Poe API for smart search
                isSearching = true;
                displaySearchLoading();

                try {
                    await window.Poe.sendUserMessage(
                        `@GPT-5.1 Search YouTube for songs matching: "${query}". Find 8 REAL YouTube music videos and return ONLY a JSON array with this EXACT format, no other text:
[{"name": "Song Title", "artist": "Artist/Channel Name", "duration": 180, "youtubeId": "VIDEO_ID", "thumbnail": "https://i.ytimg.com/vi/VIDEO_ID/default.jpg"}]

IMPORTANT:
- Use REAL YouTube video IDs from actual music videos
- Duration should be in seconds
- Include popular, high-quality official music videos or lyric videos
- Make sure the video IDs are valid and work
- Return ONLY the JSON array, nothing else`,
                        {
                            handler: 'search-handler',
                            stream: false,
                            openChat: false,
                            handlerContext: { query: query }
                        }
                    );
                } catch (err) {
                    isSearching = false;
                    showNotification('Search failed: ' + err.message);
                    displaySearchHint();
                }
            } else {
                // Use direct YouTube search for standalone app
                performYouTubeSearch(query);
            }
        }

        // YouTube search for standalone app with multiple API fallbacks
        async function performYouTubeSearch(query) {
            isSearching = true;
            displaySearchLoading();

            console.log(`Searching YouTube for: "${query}"`);

            // Strategy 0: Try Official YouTube API if key is available (BEST & FASTEST!)
            if (youtubeApiKey) {
                try {
                    console.log(`[YouTube API] Using official API with your key...`);
                    const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=8&q=${encodeURIComponent(query)}&key=${youtubeApiKey}`;

                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const results = data.items || [];

                    if (results.length === 0) throw new Error('No results');

                    console.log(`âœ“ Success with YouTube API! Found ${results.length} results`);

                    // Convert to our format
                    const songs = results.map(item => ({
                        name: item.snippet.title,
                        artist: item.snippet.channelTitle,
                        duration: 180,
                        youtubeId: item.id.videoId,
                        thumbnail: item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default.url
                    }));

                    currentSearchResults = songs;
                    displaySearchResults(songs);
                    isSearching = false;
                    return;
                } catch (err) {
                    console.log(`âœ— YouTube API failed: ${err.message}`);
                    if (err.message.includes('quota')) {
                        showNotification('âš ï¸ API quota exceeded. Using fallback APIs...');
                    } else if (err.message.includes('invalid')) {
                        showNotification('âš ï¸ Invalid API key. Using fallback APIs...');
                    }
                    // Fall through to other APIs
                }
            } else {
                console.log('[YouTube API] No API key set. Using fallback APIs (add key in Settings for better search)');
            }

            // Strategy 1: Try Piped API (more reliable than Invidious)
            const pipedInstances = [
                'https://pipedapi.kavin.rocks',
                'https://pipedapi-libre.kavin.rocks',
                'https://piped-api.garudalinux.org',
                'https://pipedapi.tokhmi.xyz',
                'https://pipedapi.moomoo.me'
            ];

            for (const instance of pipedInstances) {
                try {
                    console.log(`[Piped] Trying ${instance}...`);
                    const apiUrl = `${instance}/search?q=${encodeURIComponent(query)}&filter=all`;

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    const results = data.items || [];

                    if (results.length === 0) throw new Error('No results');

                    console.log(`âœ“ Success with Piped ${instance}! Found ${results.length} results`);

                    // Convert to our format
                    const songs = results.slice(0, 8).map(video => ({
                        name: video.title || 'Unknown',
                        artist: video.uploaderName || 'Unknown Artist',
                        duration: video.duration || 180,
                        youtubeId: video.url ? video.url.replace('/watch?v=', '') : '',
                        thumbnail: video.thumbnail || `https://i.ytimg.com/vi/${video.url?.replace('/watch?v=', '')}/mqdefault.jpg`
                    }));

                    currentSearchResults = songs;
                    displaySearchResults(songs);
                    isSearching = false;
                    return;
                } catch (err) {
                    console.log(`âœ— Failed with Piped ${instance}: ${err.message}`);
                }
            }

            // Strategy 2: Try Invidious API as backup
            const invidiousInstances = [
                'https://invidious.jing.rocks',
                'https://iv.ggtyler.dev',
                'https://invidious.privacydev.net',
                'https://inv.tux.pizza',
                'https://vid.puffyan.us'
            ];

            for (const instance of invidiousInstances) {
                try {
                    console.log(`[Invidious] Trying ${instance}...`);
                    const apiUrl = `${instance}/api/v1/search?q=${encodeURIComponent(query)}&type=video`;

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const results = await response.json();

                    if (!results || results.length === 0) throw new Error('No results');

                    console.log(`âœ“ Success with Invidious ${instance}! Found ${results.length} results`);

                    const songs = results.slice(0, 8).map(video => ({
                        name: video.title,
                        artist: video.author,
                        duration: video.lengthSeconds || 180,
                        youtubeId: video.videoId,
                        thumbnail: `https://i.ytimg.com/vi/${video.videoId}/mqdefault.jpg`
                    }));

                    currentSearchResults = songs;
                    displaySearchResults(songs);
                    isSearching = false;
                    return;
                } catch (err) {
                    console.log(`âœ— Failed with Invidious ${instance}: ${err.message}`);
                }
            }

            // All APIs failed - show fallback
            console.log('âš ï¸ All API instances failed (tried 10 servers)');
            isSearching = false;
            showNotification('Search unavailable. Use Manual Add instead.');
            displayYouTubeSearchGuide(query);
        }

        // Display YouTube search guide for standalone
        function displayYouTubeSearchGuide(query) {
            const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;

            searchResults.innerHTML = `
                <div class="search-hint">
                    <i class="fas fa-youtube" style="color: #ff0000; font-size: 48px;"></i>
                    <h3 style="margin-top: 16px;">Search on YouTube</h3>
                    <p style="margin-bottom: 24px; color: var(--text-secondary);">AI search requires Poe platform. Use this quick method instead:</p>

                    <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; text-align: left;">
                        <h4 style="color: var(--accent-primary); margin-bottom: 16px;">ðŸŽµ Quick Add in 3 Steps:</h4>
                        <ol style="color: var(--text-secondary); line-height: 2; margin-left: 20px;">
                            <li style="margin-bottom: 12px;">
                                <strong style="color: var(--text-primary);">Open YouTube:</strong><br>
                                <a href="${searchUrl}" target="_blank"
                                   style="color: var(--accent-primary); text-decoration: none; display: inline-block; margin-top: 8px; padding: 10px 20px; background: rgba(255,0,0,0.1); border-radius: 8px;">
                                    <i class="fas fa-external-link-alt"></i> Search "${query}" on YouTube
                                </a>
                            </li>
                            <li style="margin-bottom: 12px;">
                                <strong style="color: var(--text-primary);">Find your song</strong> and copy its URL
                            </li>
                            <li>
                                <strong style="color: var(--text-primary);">Come back here</strong> and use <strong style="color: var(--accent-primary);">"Add Song Manually"</strong> from the menu
                            </li>
                        </ol>
                    </div>

                    <div style="margin-top: 24px;">
                        <button onclick="openManualAddModal()"
                                style="width: 100%; padding: 16px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-plus"></i> Add Song Manually
                        </button>
                    </div>
                </div>
            `;
        }

        // Manual add interface for standalone app
        function displayManualAddInterface(query) {
            // Hide search input in standalone mode
            if (searchInput) {
                searchInput.style.display = 'none';
            }
            const searchIcon = document.querySelector('.search-icon');
            if (searchIcon) {
                searchIcon.style.display = 'none';
            }

            searchResults.innerHTML = `
                <div class="search-hint">
                    <i class="fas fa-youtube" style="color: #ff0000;"></i>
                    <h3>Add YouTube Songs</h3>
                    <p style="margin-bottom: 24px;">Add any song from YouTube to your library</p>

                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; text-align: left;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">YouTube URL or Video ID</label>
                            <input type="text" id="manualYoutubeUrl" placeholder="https://youtube.com/watch?v=dQw4w9WgXcQ or dQw4w9WgXcQ"
                                style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Song Name</label>
                                <input type="text" id="manualSongName" placeholder="Song Title"
                                    style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600;">Artist</label>
                                <input type="text" id="manualArtist" placeholder="Artist Name"
                                    style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                            </div>
                        </div>

                        <button onclick="addManualSong()"
                            style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-plus"></i> Add Song
                        </button>
                    </div>

                    <div style="margin-top: 24px; padding: 16px; background: rgba(0, 217, 255, 0.1); border-radius: 8px; text-align: left;">
                        <h4 style="margin-bottom: 8px; color: var(--accent-primary);">ðŸ’¡ How to find YouTube video IDs:</h4>
                        <ol style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                            <li>Go to YouTube and find the song you want</li>
                            <li>Copy the URL (e.g., youtube.com/watch?v=<strong>dQw4w9WgXcQ</strong>)</li>
                            <li>Paste it above - it will extract the video ID automatically</li>
                        </ol>
                    </div>
                </div>
            `;
        }

        // Add song manually
        function addManualSong() {
            const urlInput = document.getElementById('manualYoutubeUrl');
            const nameInput = document.getElementById('manualSongName');
            const artistInput = document.getElementById('manualArtist');

            const urlValue = urlInput.value.trim();
            const name = nameInput.value.trim();
            const artist = artistInput.value.trim();

            if (!urlValue) {
                showNotification('Please enter a YouTube URL or video ID');
                return;
            }

            if (!name || !artist) {
                showNotification('Please enter song name and artist');
                return;
            }

            // Extract YouTube video ID
            let videoId = '';
            if (urlValue.includes('youtube.com') || urlValue.includes('youtu.be')) {
                // Extract from URL
                const urlMatch = urlValue.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                if (urlMatch) {
                    videoId = urlMatch[1];
                }
            } else if (urlValue.match(/^[a-zA-Z0-9_-]{11}$/)) {
                // Already a video ID
                videoId = urlValue;
            }

            if (!videoId) {
                showNotification('Invalid YouTube URL or video ID');
                return;
            }

            // Check if already exists
            const exists = tracks.some(t => t.youtubeId === videoId);
            if (exists) {
                showNotification('This song is already in your library');
                return;
            }

            // Add to library
            const newTrack = {
                id: nextTrackId++,
                name: name,
                artist: artist,
                duration: 180, // Default duration
                frequency: 200 + Math.random() * 600,
                liked: false,
                youtubeId: videoId
            };

            tracks.push(newTrack);
            showNotification(`Added "${name}" by ${artist}`);

            // Clear inputs
            urlInput.value = '';
            nameInput.value = '';
            artistInput.value = '';

            // Scroll to top of form
            searchResults.scrollTop = 0;
        }

        // Handle search response from Poe
        function handleSearchResponse(result, context) {
            const msg = result.responses[0];

            if (msg.status === 'error') {
                isSearching = false;
                showNotification('Search error: ' + msg.statusText);
                displaySearchHint();
                return;
            }

            if (msg.status === 'complete') {
                isSearching = false;
                try {
                    // Extract JSON from response
                    let jsonText = msg.content.trim();

                    // Remove markdown code blocks if present
                    jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');

                    // Try to find JSON array in the response
                    const jsonMatch = jsonText.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        jsonText = jsonMatch[0];
                    }

                    const results = JSON.parse(jsonText);
                    currentSearchResults = results;
                    displaySearchResults(results);
                } catch (e) {
                    console.error('Failed to parse search results:', e);
                    showNotification('Failed to parse search results');
                    displaySearchHint();
                }
            }
        }

        // Display search hint
        function displaySearchHint() {
            searchResults.innerHTML = `
                <div class="search-hint">
                    <i class="fas fa-search"></i>
                    <h3>Search for Music</h3>
                    <p>Type to search for songs, artists, or albums to add to your library</p>
                </div>
            `;
        }

        // Display search loading
        function displaySearchLoading() {
            searchResults.innerHTML = `
                <div class="search-loading">
                    <i class="fas fa-spinner"></i>
                    <h3>Searching...</h3>
                </div>
            `;
        }

        // Display search results
        function displaySearchResults(results) {
            if (!results || results.length === 0) {
                searchResults.innerHTML = `
                    <div class="search-hint">
                        <i class="fas fa-music"></i>
                        <h3>No results found</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
                return;
            }

            searchResults.innerHTML = `
                <div class="search-results">
                    ${results.map((song, index) => {
                        const alreadyAdded = tracks.some(t => t.youtubeId === song.youtubeId);
                        const hasYoutube = song.youtubeId ? 'has-youtube' : '';
                        const thumbnail = song.thumbnail || 'https://i.ytimg.com/vi/' + (song.youtubeId || 'default') + '/default.jpg';

                        return `
                            <div class="search-result-item ${hasYoutube}" style="animation-delay: ${index * 0.05}s">
                                <div class="search-result-art" style="${song.thumbnail ? `background-image: url(${thumbnail}); background-size: cover; background-position: center;` : ''}">
                                    ${!song.thumbnail ? '<i class="fas fa-music"></i>' : ''}
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-name">
                                        ${song.name}
                                        ${song.youtubeId ? '<span class="youtube-badge"><i class="fab fa-youtube"></i> YT</span>' : ''}
                                    </div>
                                    <div class="search-result-artist">${song.artist}</div>
                                    <div class="search-result-meta">
                                        ${song.album ? `<span><i class="fas fa-compact-disc"></i> ${song.album}</span>` : ''}
                                        ${song.year ? `<span><i class="fas fa-calendar"></i> ${song.year}</span>` : ''}
                                        <span><i class="fas fa-clock"></i> ${formatTime(song.duration || 180)}</span>
                                    </div>
                                </div>
                                <button class="add-song-btn"
                                        onclick="addSongFromSearch(${index})"
                                        ${alreadyAdded ? 'disabled' : ''}>
                                    ${alreadyAdded ? 'Added' : '+ Add'}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Add song from search results
        function addSongFromSearch(index) {
            const song = currentSearchResults[index];
            if (!song) return;

            // Check if already exists (by YouTube ID if available)
            const exists = song.youtubeId
                ? tracks.some(t => t.youtubeId === song.youtubeId)
                : tracks.some(t =>
                    t.name.toLowerCase() === song.name.toLowerCase() &&
                    t.artist.toLowerCase() === song.artist.toLowerCase()
                );

            if (exists) {
                showNotification('Song already in your library');
                return;
            }

            // Add to library
            const newTrack = {
                id: nextTrackId++,
                name: song.name,
                artist: song.artist,
                duration: song.duration || 180,
                frequency: 200 + Math.random() * 600,
                liked: false,
                youtubeId: song.youtubeId || null
            };

            tracks.push(newTrack);
            showNotification(`Added "${song.name}" by ${song.artist}`);

            // Re-render search results to update button state
            displaySearchResults(currentSearchResults);
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        }

        // Close mobile menu
        function closeMobileMenu() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        }

        // Switch view
        function switchView(view) {
            // Close mobile menu when switching views
            closeMobileMenu();
            currentView = view;
            currentPlaylist = null;

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');

            // Update UI
            if (view === 'search') {
                searchContainer.classList.add('active');
                contentTitle.textContent = 'Search';
                displaySearchHint();
                searchInput.focus();

                // Hide tracks grid in search view
                tracksGrid.style.display = 'none';
                // Add search-view class to body for mobile player hiding
                document.body.classList.add('search-view');
            } else {
                searchContainer.classList.remove('active');
                searchQuery = '';
                searchInput.value = '';
                tracksGrid.style.display = 'grid';
                // Remove search-view class from body
                document.body.classList.remove('search-view');

                if (view === 'home') {
                    contentTitle.textContent = 'Discover';
                } else if (view === 'library') {
                    contentTitle.textContent = 'Your Library';
                } else if (view === 'liked') {
                    contentTitle.textContent = 'Liked Songs';
                }
            }

            renderPlaylists();
            renderTracks();
        }

        // View playlist
        function viewPlaylist(playlistId) {
            // Close mobile menu when viewing playlist
            closeMobileMenu();

            currentView = 'playlist';
            currentPlaylist = playlistId;

            const playlist = playlists.find(p => p.id === playlistId);
            if (playlist) {
                contentTitle.textContent = playlist.name;
            }

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            searchContainer.classList.remove('active');
            searchQuery = '';
            searchInput.value = '';

            renderPlaylists();
            renderTracks();
        }

        // Play track
        function playTrack(trackId) {
            const track = tracks.find(t => t.id === trackId);
            if (!track) return;

            currentTrack = track;
            currentTime = 0;
            updatePlayerUI();
            updateTrackUI();
            startPlayback();
        }

        // Toggle play/pause
        function togglePlay() {
            if (!currentTrack) {
                playTrack(tracks[0].id);
                return;
            }

            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        // Start playback
        function startPlayback() {
            // Use Piped player (ad-free!) if track has YouTube ID
            if (currentTrack.youtubeId && videoPlayerReady && videoPlayer) {
                stopAudio(); // Stop any oscillator audio first

                try {
                    // Load Piped embed (no ads!)
                    const pipedUrl = `${pipedInstance}/embed/${currentTrack.youtubeId}?autoplay=1&start=${Math.floor(currentTime)}`;
                    videoPlayer.src = pipedUrl;

                    isPlaying = true;
                    updatePlayButtonUI();
                    updateMediaSession(); // Enable background playback
                    requestWakeLock(); // Keep screen on during playback
                    showNotification(`ðŸŽµ Playing: ${currentTrack.name} (Ad-Free!)`);

                    console.log('â–¶ï¸ Playing via Piped (no ads!):', currentTrack.name);
                } catch (e) {
                    console.error('Piped playback failed:', e);
                    showNotification('Failed to play from Piped, using backup audio');
                    startOscillatorPlayback();
                }
            } else {
                // Fallback to oscillator for non-YouTube tracks
                startOscillatorPlayback();
            }
        }

        // Start oscillator playback (fallback)
        function startOscillatorPlayback() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            stopAudio();

            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(currentTrack.frequency, audioContext.currentTime);

            gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();

            isPlaying = true;
            updatePlayButtonUI();
            startProgressUpdate();
        }

        // Pause playback
        function pausePlayback() {
            if (currentTrack && currentTrack.youtubeId && videoPlayerReady && videoPlayer) {
                try {
                    // Stop Piped player by removing src
                    videoPlayer.src = '';
                } catch (e) {
                    console.error('Piped pause failed:', e);
                }
            } else {
                stopAudio();
                stopProgressUpdate();
            }

            isPlaying = false;
            updatePlayButtonUI();
            releaseWakeLock(); // Release wake lock when paused
        }

        // Stop audio
        function stopAudio() {
            // Stop oscillator
            if (oscillator) {
                try {
                    oscillator.stop();
                    oscillator.disconnect();
                } catch (e) {
                    // Ignore if already stopped
                }
                oscillator = null;
            }
            if (gainNode) {
                gainNode.disconnect();
                gainNode = null;
            }

            // Stop YouTube
            if (youtubeReady && youtubePlayer) {
                try {
                    youtubePlayer.stopVideo();
                    stopYouTubeProgressUpdate();
                } catch (e) {
                    // Ignore errors
                }
            }
        }

        // YouTube progress update
        function startYouTubeProgressUpdate() {
            stopYouTubeProgressUpdate();

            youtubeCheckInterval = setInterval(() => {
                if (!isPlaying || !youtubePlayer) {
                    stopYouTubeProgressUpdate();
                    return;
                }

                try {
                    currentTime = youtubePlayer.getCurrentTime();
                    updateProgressUI();

                    // Update volume if changed
                    if (youtubePlayer.getVolume() !== volume * 100) {
                        youtubePlayer.setVolume(volume * 100);
                    }
                } catch (e) {
                    // Ignore errors
                }
            }, 100);
        }

        function stopYouTubeProgressUpdate() {
            if (youtubeCheckInterval) {
                clearInterval(youtubeCheckInterval);
                youtubeCheckInterval = null;
            }
        }

        // Start progress update
        function startProgressUpdate() {
            const startTime = Date.now() - (currentTime * 1000);

            function update() {
                if (!isPlaying) return;

                const elapsed = (Date.now() - startTime) / 1000;
                currentTime = Math.min(elapsed, currentTrack.duration);

                updateProgressUI();

                if (currentTime >= currentTrack.duration) {
                    handleTrackEnd();
                } else {
                    animationFrame = requestAnimationFrame(update);
                }
            }

            update();
        }

        // Stop progress update
        function stopProgressUpdate() {
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
        }

        // Handle track end
        function handleTrackEnd() {
            if (repeatMode === 2) {
                // Repeat one
                currentTime = 0;
                startPlayback();
            } else {
                playNext();
            }
        }

        // Play next
        function playNext() {
            if (!currentTrack) return;

            let nextIndex;
            if (isShuffle) {
                nextIndex = Math.floor(Math.random() * tracks.length);
            } else {
                const currentIndex = tracks.findIndex(t => t.id === currentTrack.id);
                nextIndex = (currentIndex + 1) % tracks.length;
            }

            playTrack(tracks[nextIndex].id);
        }

        // Play previous
        function playPrevious() {
            if (!currentTrack) return;

            if (currentTime > 3) {
                currentTime = 0;
                if (isPlaying) startPlayback();
                return;
            }

            const currentIndex = tracks.findIndex(t => t.id === currentTrack.id);
            const prevIndex = (currentIndex - 1 + tracks.length) % tracks.length;
            playTrack(tracks[prevIndex].id);
        }

        // Seek track
        function seekTrack(e) {
            if (!currentTrack) return;

            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            currentTime = percent * currentTrack.duration;

            // Seek YouTube player if applicable
            if (currentTrack.youtubeId && youtubeReady && youtubePlayer) {
                try {
                    youtubePlayer.seekTo(currentTime, true);
                } catch (e) {
                    console.error('YouTube seek failed:', e);
                }
            }

            if (isPlaying) {
                startPlayback();
            } else {
                updateProgressUI();
            }
        }

        // Change volume
        function changeVolume(e) {
            const rect = volumeSlider.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            volume = percent;
            updateVolumeUI();

            if (gainNode) {
                gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
            }
        }

        // Toggle mute
        function toggleMute() {
            if (volume > 0) {
                volume = 0;
            } else {
                volume = 0.7;
            }
            updateVolumeUI();

            if (gainNode) {
                gainNode.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
            }
        }

        // Toggle shuffle
        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.style.color = isShuffle ? 'var(--accent-primary)' : 'var(--text-secondary)';
        }

        // Toggle repeat
        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const icon = repeatBtn.querySelector('i');

            if (repeatMode === 0) {
                repeatBtn.style.color = 'var(--text-secondary)';
                icon.className = 'fas fa-redo';
            } else if (repeatMode === 1) {
                repeatBtn.style.color = 'var(--accent-primary)';
                icon.className = 'fas fa-redo';
            } else {
                repeatBtn.style.color = 'var(--accent-primary)';
                icon.className = 'fas fa-redo-alt';
            }
        }

        // Toggle theme
        function toggleTheme() {
            document.documentElement.classList.toggle('light');
            const icon = themeToggle.querySelector('i');
            icon.className = document.documentElement.classList.contains('light') ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Update player UI
        function updatePlayerUI() {
            if (!currentTrack) return;

            document.querySelector('.player-track-name').textContent = currentTrack.name;
            document.querySelector('.player-track-artist').textContent = currentTrack.artist;
            totalTimeEl.textContent = formatTime(currentTrack.duration);
        }

        // Update play button UI
        function updatePlayButtonUI() {
            const icon = playBtn.querySelector('i');
            icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        }

        // Update progress UI
        function updateProgressUI() {
            const percent = (currentTime / currentTrack.duration) * 100;
            progressBarFill.style.width = `${percent}%`;
            currentTimeEl.textContent = formatTime(currentTime);
        }

        // Update volume UI
        function updateVolumeUI() {
            volumeSliderFill.style.width = `${volume * 100}%`;
            const icon = volumeBtn.querySelector('i');

            if (volume === 0) {
                icon.className = 'fas fa-volume-mute';
            } else if (volume < 0.5) {
                icon.className = 'fas fa-volume-down';
            } else {
                icon.className = 'fas fa-volume-up';
            }
        }

        // Update track UI
        function updateTrackUI() {
            document.querySelectorAll('.track-item').forEach(item => {
                const trackId = parseInt(item.dataset.trackId);
                if (trackId === currentTrack.id) {
                    item.classList.add('playing');
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        // Format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        // Modal helper functions
        function createModal(title, bodyHTML, onConfirm, confirmText = 'Confirm') {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">${title}</div>
                        <button class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${bodyHTML}
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary modal-cancel">Cancel</button>
                        <button class="btn btn-primary modal-confirm">${confirmText}</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            const closeModal = () => overlay.remove();

            overlay.querySelector('.modal-close').addEventListener('click', closeModal);
            overlay.querySelector('.modal-cancel').addEventListener('click', closeModal);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeModal();
            });

            overlay.querySelector('.modal-confirm').addEventListener('click', () => {
                onConfirm(overlay);
            });

            // Focus first input
            const firstInput = overlay.querySelector('.form-input');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }

            return overlay;
        }

        // Open manual add song modal
        function openManualAddModal() {
            closeMobileMenu(); // Close sidebar if open

            const modal = createModal(
                'Add Song Manually',
                `
                    <div class="form-group">
                        <label class="form-label">YouTube URL or Video ID</label>
                        <input type="text" class="form-input" id="youtubeUrl" placeholder="https://youtube.com/watch?v=dQw4w9WgXcQ">
                        <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">Paste a YouTube link or just the video ID</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Song Name</label>
                        <input type="text" class="form-input" id="songName" placeholder="Enter song name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Artist</label>
                        <input type="text" class="form-input" id="songArtist" placeholder="Enter artist name">
                    </div>
                `,
                (overlay) => {
                    const youtubeUrl = overlay.querySelector('#youtubeUrl').value.trim();
                    const name = overlay.querySelector('#songName').value.trim();
                    const artist = overlay.querySelector('#songArtist').value.trim();

                    if (!name || !artist) {
                        showNotification('Please fill in all fields');
                        return;
                    }

                    // Extract YouTube video ID
                    let videoId = null;
                    if (youtubeUrl) {
                        if (youtubeUrl.includes('youtube.com') || youtubeUrl.includes('youtu.be')) {
                            const urlMatch = youtubeUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                            if (urlMatch) {
                                videoId = urlMatch[1];
                            }
                        } else if (youtubeUrl.match(/^[a-zA-Z0-9_-]{11}$/)) {
                            videoId = youtubeUrl;
                        }
                    }

                    // Add song
                    const newTrack = {
                        id: nextTrackId++,
                        name: name,
                        artist: artist,
                        duration: 180,
                        frequency: 200 + Math.random() * 600,
                        liked: false,
                        youtubeId: videoId
                    };

                    tracks.push(newTrack);
                    renderTracks();
                    showNotification(`Added "${name}" by ${artist}` + (videoId ? ' (with YouTube playback)' : ''));
                    overlay.remove();
                },
                'Add Song'
            );
        }

        // Cookie helper functions
        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
        }

        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, '');
        }

        // Open settings modal
        function openSettings() {
            closeMobileMenu();

            const modal = createModal(
                'Settings',
                `
                    <div class="form-group">
                        <label class="form-label">YouTube API Key (Optional)</label>
                        <input type="text" class="form-input" id="apiKeyInput" placeholder="AIzaSy..." value="${youtubeApiKey}">
                        <small style="color: var(--text-muted); font-size: 12px; margin-top: 8px; display: block; line-height: 1.5;">
                            âœ… <strong>Get a FREE API key</strong> to enable reliable YouTube search:<br>
                            1. Go to <a href="https://console.cloud.google.com" target="_blank" style="color: var(--accent-primary);">Google Cloud Console</a><br>
                            2. Create a new project (or select existing)<br>
                            3. Enable "YouTube Data API v3"<br>
                            4. Go to Credentials â†’ Create Credentials â†’ API Key<br>
                            5. Copy and paste the key here<br><br>
                            ðŸ“Š Free quota: 10,000 units/day (100 searches/day)<br>
                            ${youtubeApiKey ? 'ðŸŸ¢ <strong>API Key is set! Search will use official YouTube API.</strong>' : 'ðŸŸ¡ <strong>No key set. Using fallback APIs (may be slow/unreliable).</strong>'}
                        </small>
                    </div>
                    <div class="form-group" style="margin-top: 24px;">
                        <label class="form-label">Theme</label>
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button class="btn-secondary" id="themeLight" style="flex: 1;">â˜€ï¸ Light</button>
                            <button class="btn-secondary" id="themeDark" style="flex: 1;">ðŸŒ™ Dark</button>
                        </div>
                    </div>
                `,
                (overlay) => {
                    const newKey = overlay.querySelector('#apiKeyInput').value.trim();
                    if (newKey !== youtubeApiKey) {
                        youtubeApiKey = newKey;
                        setCookie('ytApiKey', newKey);
                        showNotification(newKey ? 'API key saved! Search will be faster & more reliable.' : 'API key removed. Using fallback APIs.');
                    }
                    overlay.remove();
                },
                'Save Settings'
            );

            // Theme buttons
            setTimeout(() => {
                document.getElementById('themeLight')?.addEventListener('click', () => {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                });
                document.getElementById('themeDark')?.addEventListener('click', () => {
                    document.documentElement.classList.remove('light');
                    document.documentElement.classList.add('dark');
                });
            }, 0);
        }

        // Open create playlist modal
        function openCreatePlaylistModal() {
            const modal = createModal(
                'Create Playlist',
                `
                    <div class="form-group">
                        <label class="form-label">Playlist Name</label>
                        <input type="text" class="form-input" id="playlistName" placeholder="My Awesome Playlist">
                    </div>
                `,
                (overlay) => {
                    const name = overlay.querySelector('#playlistName').value.trim();

                    if (!name) {
                        showNotification('Please enter a playlist name');
                        return;
                    }

                    // Create playlist
                    const newPlaylist = {
                        id: nextPlaylistId++,
                        name: name,
                        tracks: []
                    };

                    playlists.push(newPlaylist);
                    renderPlaylists();
                    showNotification(`Created playlist "${name}"`);
                    overlay.remove();
                },
                'Create'
            );
        }

        // Open add to playlist modal
        function openAddToPlaylistModal(trackId) {
            const track = tracks.find(t => t.id === trackId);
            if (!track) return;

            if (playlists.length === 0) {
                showNotification('Create a playlist first!');
                return;
            }

            const playlistOptions = playlists.map(p =>
                `<div style="padding: 12px; cursor: pointer; border-radius: 8px; transition: all 0.2s;"
                      onmouseover="this.style.background='var(--hover-bg)'"
                      onmouseout="this.style.background='transparent'"
                      onclick="addTrackToPlaylist(${trackId}, ${p.id})">
                    <div style="font-weight: 600;">${p.name}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">${p.tracks.length} songs</div>
                </div>`
            ).join('');

            const modal = createModal(
                `Add "${track.name}" to Playlist`,
                `<div style="display: flex; flex-direction: column; gap: 8px;">${playlistOptions}</div>`,
                () => {},
                'Close'
            );

            // Remove confirm button since we're clicking on options
            modal.querySelector('.modal-confirm').style.display = 'none';
        }

        // Add track to playlist
        function addTrackToPlaylist(trackId, playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            const track = tracks.find(t => t.id === trackId);

            if (!playlist || !track) return;

            if (playlist.tracks.includes(trackId)) {
                showNotification(`"${track.name}" is already in ${playlist.name}`);
            } else {
                playlist.tracks.push(trackId);
                showNotification(`Added "${track.name}" to ${playlist.name}`);
            }

            // Close modal
            document.querySelector('.modal-overlay')?.remove();
        }

        // Delete playlist
        function deletePlaylist(playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return;

            const modal = createModal(
                'Delete Playlist',
                `<p>Are you sure you want to delete "${playlist.name}"? This action cannot be undone.</p>`,
                (overlay) => {
                    playlists = playlists.filter(p => p.id !== playlistId);

                    if (currentPlaylist === playlistId) {
                        switchView('home');
                    } else {
                        renderPlaylists();
                    }

                    showNotification(`Deleted playlist "${playlist.name}"`);
                    overlay.remove();
                },
                'Delete'
            );
        }

        // Toggle like track
        function toggleLikeTrack(trackId) {
            const track = tracks.find(t => t.id === trackId);
            if (!track) return;

            track.liked = !track.liked;
            renderTracks();
            showNotification(track.liked ? `Liked "${track.name}"` : `Unliked "${track.name}"`);
        }

        // Delete track function
        function deleteTrack(trackId) {
            const track = tracks.find(t => t.id === trackId);
            if (!track) return;

            // Show custom confirmation modal
            const modal = createModal(
                'Delete Song',
                `
                    <div style="padding: 20px 0; text-align: center;">
                        <i class="fas fa-trash" style="font-size: 48px; color: var(--accent-secondary); margin-bottom: 16px;"></i>
                        <p style="font-size: 16px; margin-bottom: 8px;">Are you sure you want to delete this song?</p>
                        <p style="font-weight: 600; font-size: 18px;">"${track.name}"</p>
                        <p style="color: var(--text-muted); font-size: 14px;">by ${track.artist}</p>
                    </div>
                `,
                (overlay) => {
                    // Stop playing if this track is currently playing
                    if (currentTrack?.id === trackId) {
                        stopTrack();
                        currentTrack = null;
                    }

                    // Remove from tracks array
                    const index = tracks.findIndex(t => t.id === trackId);
                    if (index > -1) {
                        tracks.splice(index, 1);
                    }

                    // Remove from all playlists
                    playlists.forEach(playlist => {
                        playlist.tracks = playlist.tracks.filter(id => id !== trackId);
                    });

                    // Re-render
                    renderTracks();
                    renderPlaylists();
                    showNotification(`Deleted "${track.name}"`);
                    overlay.remove();
                },
                'Delete',
                'Cancel'
            );
        }

        function showNotification(message) {
            // Create custom notification instead of alert
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-secondary);
                color: var(--text-primary);
                padding: 16px 24px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow);
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Initialize app
        console.log('ðŸŽµ Maya World Music v2.0 loaded! Settings button available in sidebar.');
        console.log('YouTube API Key:', youtubeApiKey ? 'âœ… Set (' + youtubeApiKey.substring(0, 10) + '...)' : 'âš ï¸ Not set (go to Settings to add)');
        init();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install notification
            const installNotification = document.createElement('div');
            installNotification.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                color: white;
                padding: 16px 24px;
                border-radius: 24px;
                box-shadow: var(--shadow);
                z-index: 10000;
                display: flex;
                gap: 12px;
                align-items: center;
                animation: fadeIn 0.3s ease-out;
                max-width: 90%;
            `;
            installNotification.innerHTML = `
                <i class="fas fa-mobile-alt"></i>
                <span>Install Vibestream on your device</span>
                <button style="background: white; color: var(--accent-primary); border: none; padding: 8px 16px; border-radius: 16px; font-weight: 600; cursor: pointer;">Install</button>
                <button style="background: transparent; border: none; color: white; padding: 8px; cursor: pointer; font-size: 18px;">Ã—</button>
            `;
            document.body.appendChild(installNotification);

            const installBtn = installNotification.querySelectorAll('button')[0];
            const closeBtn = installNotification.querySelectorAll('button')[1];

            installBtn.addEventListener('click', async () => {
                installNotification.remove();
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
            });

            closeBtn.addEventListener('click', () => {
                installNotification.remove();
            });

            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (installNotification.parentElement) {
                    installNotification.remove();
                }
            }, 10000);
        });

        // Log when app is installed
        window.addEventListener('appinstalled', () => {
            console.log('Vibestream has been installed!');
            showNotification('Vibestream installed successfully! ðŸŽµ');
        });
    </script>
</body>
</html>